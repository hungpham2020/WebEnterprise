@using System.Security.Claims
@model IEnumerable<WebEnterprise.Models.DTO.PostDTO>
@{
    ViewData["Title"] = "Index";
    Layout = "../Shared/_Layout.cshtml";
}


@{
    List<int> selectedids = new List<int>();
    if (TempData["CatIds"] != null)
    {
        selectedids = TempData["CatIds"].ToString().Split(',')
        .Select(id => Int32.Parse(id)).ToList();
    }
    var userid = User.FindFirstValue(ClaimTypes.NameIdentifier);
}
<!DOCTYPE html>
<html>
<head>
    <style>

        .Add {
            margin-left: 80%;
            display: inline-grid;
            margin-bottom: 1%;
        }
    </style>
</head>

<h1 class="text-center">
    View Posts
</h1>

@if (TempData["message"] != null)
{
    ViewBag.Message = TempData["message"];
}
@Html.Partial("_Message")

<div class="nk-content ">
    <div class="nk-block-head-content">
        <ul class="nk-block-tools">
            <li class="nk-block-tools-opt">
                <a data-target="addpost" class="toggle btn btn-info " style=" color:white"><em class="icon ni ni-plus"></em><span>Add Post</span></a>
            </li>
        </ul>
    </div>
</div>

<div class="nk-block">
    <div class="card-inner-group">
        <div class="nk-content-inner">

            <div class="nk-content-body">
                @foreach (var item in Model)
                {
                    <div class="col-xxl-6 mb-2">
                        <div class="card h-100">
                            <div class="card-inner">
                                <div class="card-title-group align-start gx-3 mb-3">
                                    <div class="card-title">
                                        <h6 class="title">@Html.DisplayFor(modelItem => item.Title)</h6>
                                        <span class="tb-sub">By
                                            @if (!string.IsNullOrEmpty(item.AuthorName))
                                            {
                                                @Html.DisplayFor(modelItem => item.AuthorName)
                                            }
                                            else
                                            {
                                                <span>Admin</span>
                                            }
                                        </span>

                                        <p>On @Html.DisplayFor(modelItem => item.OpenDate)</p>
                                    </div>
                                </div>

                                <div class="nk-sale-data-group align-center justify-between gy-3 gx-5">
                                    @*//-------------------------------------------------------------*@

                                    <div class="nk-tb-col">
                                        <span class="tb-sub">
                                            @Html.DisplayFor(modelItem => item.Description)
                                        </span>
                                    </div>

                                    @*----------------------------------------------------------*@

                                    @*
                                        <div class="nk-sale-data">
                                        <span class="amount sm">1,937 <small>Subscribers</small></span>
                                        </div>*@

                                </div>
                            </div><!-- .card -->


                        <div id="Placeholder"></div>

                            @*-----------Like and comment-------------*@
                            <div>
                                <div class="btn-parent row text-center">
                                    <div class="col-2 ml-2">
                                        <div class="row">
                                            <div class="col">Like: @item.Like</div>
                                            <div class="col">DisLike: @item.DisLike</div>
                                        </div>
                                    </div>
                                    <div class="col-9 text-center">
                                        <input hidden value="@item.Id" class="post-id" />
                                        @if (item.Status == true)
                                        {
                                            <button type="button" class="btn btn-primary" disabled>
                                                Liked
                                            </button>
                                        }
                                        else if (item.Status == false)
                                        {
                                            <button type="button" class="btn btn-primary" disabled>
                                                DisLiked
                                            </button>
                                        }
                                        else
                                        {
                                            <button type="button" class="btn btn-primary btn-like">
                                                Like
                                            </button>
                                            <button type="button" class="btn btn-primary btn-dislike">
                                                DisLike
                                            </button>
                                        }
                                        <button class="btn btn-info">
                                            @Html.ActionLink("Comment", "ShowComment" ,new { id = item.Id })
                                        </button>
                                    </div>
                                    <div class="col-1"></div>
                                </div>
                            </div>

                        </div><!-- .col -->

                    </div>
                }


                <form method="post" asp-action="AddPost" asp-controller="User">
                    <div class="nk-add-product toggle-slide toggle-slide-right" data-content="addpost" data-toggle-screen="any" data-toggle-overlay="true" data-toggle-body="true" data-simplebar>
                        <div class="nk-block-head">
                            <div class="nk-block-head-content">
                                <h5 class="nk-block-title">New Post</h5>
                                <div class="nk-block-des">
                                    <p>Add Post Status.</p>
                                </div>
                            </div>
                        </div><!-- .nk-block-head -->



                        <div class="nk-block">
                            <div class="row g-3">
                                <div class="col-12">
                                    <div class="form-group">
                                        <label class="form-label" for="Email">Title</label>
                                        <div class="form-control-wrap">
                                            <input type="text" class="form-control" name="Title">
                                        </div>
                                    </div>
                                </div>


                                <div class="btn-group">
                                    <button class="btn btn-outline-dark btn-lg dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                        Category
                                    </button>
                                    <div class="dropdown-menu">

                                        @foreach (var r in ViewBag.Cat)
                                        {
                                            <li class="nk-menu-item has-sub">
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="radio"
                                                        value="@r.Id" id="@r.Name" name="CatIds"
                                                        @(selectedids.Contains(r.Id) ? "checked" : string.Empty) />
                                                    <label class="form-check-label" for="@r.Name">
                                                        @r.Name
                                                    </label>
                                                </div>
                                            </li>
                                        }

                                    </div>
                                </div>

                                <div class="col-12">
                                    <div class="form-group">
                                        <label class="form-label" for="Description">Description</label>
                                        <div class="form-control-wrap">
                                            <input type="text" class="form-control" name="Description">
                                        </div>
                                    </div>
                                </div>

                                <div class="col-12">
                                    <button class="btn btn-primary"><em class="icon ni ni-plus"></em><span>Add</span></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>


            </div>
        </div>
    </div>
</div>





@section Scripts{
    <script type="text/javascript">
        $(function() {
          $( "i" ).click(function() {
            $( "i,span" ).toggleClass( "press", 1000 );
          });
        });

        $(document).ready(function() {
            $('.btn-like').click(function(){
                var parent = $(this).parents('.btn-parent')
                var postId = parent.find('.post-id').val()
                var userId = "@userid"
                var thisEl = $(this)
                var data = {
                    "postId": postId,
                    "userId": userId,
                }
                $.ajax({
                    type: 'POST',
                    url: '@Url.Action("Like", "User")',
                    data: req = JSON.stringify(data),
                    cache: false,
                    dataType: "json",
                    contentType: "application/json; charset=utf-8",
                    processData: false,
                    success: function(res){
                        thisEl.text("Liked")
                        thisEl.attr('disabled', true)
                        parent.find('.btn-dislike').hide()
                    }
                })
            })
            $('.btn-dislike').click(function(){
                var parent = $(this).parents('.btn-parent')
                var postId = parent.find('.post-id').val()
                var userId = "@userid"
                var thisEl = $(this)
                var data = {
                    "postId": postId,
                    "userId": userId,
                }
                $.ajax({
                    type: 'POST',
                    url: '@Url.Action("DisLike", "User")',
                    data: req = JSON.stringify(data),
                    cache: false,
                    dataType: "json",
                    contentType: "application/json; charset=utf-8",
                    processData: false,
                    success: function(res){
                        thisEl.text("DisLiked")
                        thisEl.attr('disabled', true)
                        parent.find('.btn-like').hide()
                    }
                })
            })
        })
    </script>
}
